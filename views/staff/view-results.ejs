<%- include('../layout/header') %>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-10">
            
            <!-- Search Card -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0"><i class="fas fa-search me-2"></i>Check Student Results</h4>
                </div>
                <div class="card-body">
                    <form action="/staff/view-results" method="POST" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Admission Number</label>
                            <input type="text" name="admission_number" class="form-control" required placeholder="STU2025001" value="<%= typeof student !== 'undefined' && student ? student.admission_number : '' %>">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Term</label>
                            <select name="term" class="form-select" required>
                                <option value="1st Term" <%= typeof term !== 'undefined' && term === '1st Term' ? 'selected' : '' %>>1st Term</option>
                                <option value="2nd Term" <%= typeof term !== 'undefined' && term === '2nd Term' ? 'selected' : '' %>>2nd Term</option>
                                <option value="3rd Term" <%= typeof term !== 'undefined' && term === '3rd Term' ? 'selected' : '' %>>3rd Term</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Academic Year</label>
                            <input type="text" name="academic_year" class="form-control" value="<%= typeof academic_year !== 'undefined' ? academic_year : '2024/2025' %>" required>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">Check</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Display -->
            <% if (search && student) { %>
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="text-center mb-4">
                            <h3 class="fw-bold"><%= student.first_name %> <%= student.last_name %></h3>
                            <p class="text-muted mb-0">Admission No: <%= student.admission_number %> | Class: <%= student.class %></p>
                            <p class="text-muted">Term: <%= term %> | Year: <%= academic_year %></p>
                        </div>

                        <% if (results && results.length > 0) { %>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Subject</th>
                                            <th class="text-center">Score</th>
                                            <th class="text-center">Grade</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% results.forEach(result => { %>
                                            <tr>
                                                <td><%= result.subject %></td>
                                                <td class="text-center fw-bold"><%= result.score %></td>
                                                <td class="text-center">
                                                    <span class="badge bg-<%= result.grade === 'A' ? 'success' : (result.grade === 'F' ? 'danger' : 'secondary') %>">
                                                        <%= result.grade %>
                                                    </span>
                                                </td>
                                                <td class="text-center">
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-outline-primary edit-subject-btn"
                                                                data-subject="<%= result.subject %>"
                                                                data-student="<%= student.admission_number %>"
                                                                data-term="<%= term %>"
                                                                data-year="<%= academic_year %>"
                                                                data-score="<%= result.score %>"
                                                                onclick="startEdit(this)">
                                                            <i class="fas fa-edit"></i> Edit
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-danger delete-subject-btn"
                                                                data-subject="<%= result.subject %>"
                                                                data-student="<%= student.admission_number %>"
                                                                data-term="<%= term %>"
                                                                data-year="<%= academic_year %>"
                                                                onclick="confirmDelete(this)">
                                                            <i class="fas fa-trash"></i> Delete
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        <% }); %>

                                        <!-- TOTAL ROW -->
                                        <tr class="table-success border-top border-dark">
                                            <td class="fw-bold text-end">AVERAGE SCORE (%)</td>
                                            <td class="text-center fw-bold fs-5"><%= results.length > 0 ? (totalScore / results.length).toFixed(2) : '0.00' %>%</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div class="alert alert-warning text-center">
                                No results found for this student in the selected term.
                            </div>
                        <% } %>
                        
                        <div class="text-center mt-4">
                            <div class="btn-group" role="group">
                                <a href="/staff/download-result/<%= encodeURIComponent(student.admission_number) %>/<%= encodeURIComponent(term) %>/<%= encodeURIComponent(academic_year) %>" class="btn btn-primary">
                                    <i class="fas fa-download me-2"></i>Download PDF
                                </a>
                                <button type="button" class="btn btn-success" onclick="toggleAddSubject()">
                                    <i class="fas fa-plus me-2"></i>Add Subject
                                </button>
                                <a href="/staff/upload-result" class="btn btn-outline-success">
                                    <i class="fas fa-upload me-2"></i>Upload Results
                                </a>
                            </div>
                        </div>

                        <!-- Add Subject Form (Hidden by default) -->
                        <div id="addSubjectForm" class="card mt-3" style="display: none;">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0"><i class="fas fa-plus me-2"></i>Add New Subject</h5>
                            </div>
                            <div class="card-body">
                                <form action="/staff/add-single-result" method="POST" id="addSubjectFormElement">
                                    <input type="hidden" name="admission_number" value="<%= student.admission_number %>">
                                    <input type="hidden" name="term" value="<%= term %>">
                                    <input type="hidden" name="academic_year" value="<%= academic_year %>">
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Subject Name</label>
                                            <input type="text" name="subject" class="form-control" required placeholder="e.g. Chemistry, History, Geography">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label fw-bold">Score (0-100)</label>
                                            <input type="number" name="score" class="form-control" min="0" max="100" step="0.01" required placeholder="85.5">
                                        </div>
                                    </div>
                                    
                                    <div class="text-center">
                                        <button type="submit" class="btn btn-success me-2">
                                            <i class="fas fa-check me-2"></i>Add Subject
                                        </button>
                                        <button type="button" class="btn btn-secondary" onclick="toggleAddSubject()">
                                            <i class="fas fa-times me-2"></i>Cancel
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            <% } %>

        </div>
    </div>
</div>

<script>
function startEdit(buttonElement) {
    // Extract parameters from data attributes
    const subject = buttonElement.getAttribute('data-subject');
    const admissionNumber = buttonElement.getAttribute('data-student');
    const term = buttonElement.getAttribute('data-term');
    const academicYear = buttonElement.getAttribute('data-year');
    const currentScore = buttonElement.getAttribute('data-score');
    
    // Find the table row
    const row = buttonElement.closest('tr');
    const scoreCell = row.querySelector('td:nth-child(2)'); // Score column
    const gradeCell = row.querySelector('td:nth-child(3)'); // Grade column
    const actionsCell = row.querySelector('td:nth-child(4)'); // Actions column
    
    // Store original values as data attributes on the row
    row.setAttribute('data-edit-mode', 'true');
    row.setAttribute('data-original-score', scoreCell.textContent.trim());
    row.setAttribute('data-original-grade', gradeCell.innerHTML);
    row.setAttribute('data-edit-subject', subject);
    row.setAttribute('data-edit-student', admissionNumber);
    row.setAttribute('data-edit-term', term);
    row.setAttribute('data-edit-year', academicYear);
    
    // Replace score cell with input
    scoreCell.innerHTML = `
        <input type="number" class="form-control form-control-sm score-input" 
               value="${currentScore}" min="0" max="100" step="0.01" 
               style="width: 80px; margin: 0 auto;">
    `;
    
    // Replace grade cell with loading message
    gradeCell.innerHTML = '<span class="badge bg-info">Updating...</span>';
    
    // Replace actions with save/cancel buttons
    actionsCell.innerHTML = `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-success save-edit-btn" 
                    onclick="saveEdit(this)">
                <i class="fas fa-check"></i> Save
            </button>
            <button type="button" class="btn btn-sm btn-secondary cancel-edit-btn" 
                    onclick="cancelEdit(this)">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    `;
}

function saveEdit(buttonElement) {
    const row = buttonElement.closest('tr');
    const scoreInput = row.querySelector('.score-input');
    const newScore = parseFloat(scoreInput.value);
    
    // Extract data from row attributes
    const subject = row.getAttribute('data-edit-subject');
    const admissionNumber = row.getAttribute('data-edit-student');
    const term = row.getAttribute('data-edit-term');
    const academicYear = row.getAttribute('data-edit-year');
    
    // Validate score
    if (isNaN(newScore) || newScore < 0 || newScore > 100) {
        alert('Please enter a valid score between 0 and 100.');
        scoreInput.focus();
        return;
    }
    
    // Calculate grade based on score
    let grade = 'F';
    if (newScore >= 70) grade = 'A';
    else if (newScore >= 60) grade = 'B';
    else if (newScore >= 50) grade = 'C';
    else if (newScore >= 45) grade = 'D';
    else if (newScore >= 40) grade = 'E';
    
    // Update UI immediately
    const scoreCell = row.querySelector('td:nth-child(2)');
    const gradeCell = row.querySelector('td:nth-child(3)');
    const actionsCell = row.querySelector('td:nth-child(4)');
    
    scoreCell.innerHTML = `<span class="fw-bold">${newScore}</span>`;
    gradeCell.innerHTML = `<span class="badge bg-${grade === 'A' ? 'success' : (grade === 'F' ? 'danger' : 'secondary')}">${grade}</span>`;
    actionsCell.innerHTML = '<div class="text-muted"><i class="fas fa-spinner fa-spin"></i> Saving...</div>';
    
    // Submit the edit request
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/staff/edit-result/${encodeURIComponent(admissionNumber)}/${encodeURIComponent(term)}/${encodeURIComponent(academicYear)}`;
    
    // Add form fields
    const fields = {
        'subject': subject,
        'score': newScore,
        'grade': grade
    };
    
    for (const [name, value] of Object.entries(fields)) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = name;
        input.value = value;
        form.appendChild(input);
    }
    
    // Add CSRF token if available
    const csrfToken = document.querySelector('meta[name="csrf-token"]');
    if (csrfToken) {
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = '_token';
        csrfInput.value = csrfToken.getAttribute('content');
        form.appendChild(csrfInput);
    }
    
    // Submit the form
    document.body.appendChild(form);
    form.submit();
}

function cancelEdit(buttonElement) {
    const row = buttonElement.closest('tr');
    const scoreCell = row.querySelector('td:nth-child(2)');
    const gradeCell = row.querySelector('td:nth-child(3)');
    const actionsCell = row.querySelector('td:nth-child(4)');
    
    // Extract original values from row attributes
    const originalScore = row.getAttribute('data-original-score');
    const originalGrade = row.getAttribute('data-original-grade');
    const subject = row.getAttribute('data-edit-subject');
    const admissionNumber = row.getAttribute('data-edit-student');
    const term = row.getAttribute('data-edit-term');
    const academicYear = row.getAttribute('data-edit-year');
    
    // Restore original values
    scoreCell.innerHTML = `<span class="fw-bold">${originalScore}</span>`;
    gradeCell.innerHTML = originalGrade;
    
    // Restore original Edit/Delete buttons
    actionsCell.innerHTML = `
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-sm btn-outline-primary edit-subject-btn"
                    data-subject="${subject}"
                    data-student="${admissionNumber}"
                    data-term="${term}"
                    data-year="${academicYear}"
                    data-score="${originalScore}"
                    onclick="startEdit(this)">
                <i class="fas fa-edit"></i> Edit
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger delete-subject-btn"
                    data-subject="${subject}"
                    data-student="${admissionNumber}"
                    data-term="${term}"
                    data-year="${academicYear}"
                    onclick="confirmDelete(this)">
                <i class="fas fa-trash"></i> Delete
            </button>
        </div>
    `;
    
    // Clean up edit mode attributes
    row.removeAttribute('data-edit-mode');
    row.removeAttribute('data-original-score');
    row.removeAttribute('data-original-grade');
    row.removeAttribute('data-edit-subject');
    row.removeAttribute('data-edit-student');
    row.removeAttribute('data-edit-term');
    row.removeAttribute('data-edit-year');
}

function confirmDelete(buttonElement) {
    // Extract parameters from data attributes
    const subject = buttonElement.getAttribute('data-subject');
    const admissionNumber = buttonElement.getAttribute('data-student');
    const term = buttonElement.getAttribute('data-term');
    const academicYear = buttonElement.getAttribute('data-year');
    
    console.log('Delete button clicked:', { subject, admissionNumber, term, academicYear });
    
    if (confirm(`Are you sure you want to delete the "${subject}" result for this student? This action cannot be undone.`)) {
        console.log('Confirmed deletion, creating form...');
        
        // Create a form to submit the delete request
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/staff/delete-result/${encodeURIComponent(admissionNumber)}/${encodeURIComponent(term)}/${encodeURIComponent(academicYear)}`;
        
        console.log('Form action:', form.action);

        // Add hidden inputs
        const subjectInput = document.createElement('input');
        subjectInput.type = 'hidden';
        subjectInput.name = 'subject';
        subjectInput.value = subject;
        form.appendChild(subjectInput);
        
        console.log('Added subject input:', subject);

        // Add CSRF token if available (optional)
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
            console.log('Added CSRF token');
        }

        // Add form to body and submit
        document.body.appendChild(form);
        console.log('Form added to body, submitting...');
        
        // Submit the form
        try {
            form.submit();
            console.log('Form submitted successfully');
        } catch (error) {
            console.error('Error submitting delete form:', error);
            alert('Error deleting result. Please try again.');
        }
    } else {
        console.log('Deletion cancelled by user');
    }
}

function toggleAddSubject() {
    const form = document.getElementById('addSubjectForm');
    const button = event.target.closest('button');
    
    if (form.style.display === 'none' || form.style.display === '') {
        form.style.display = 'block';
        button.innerHTML = '<i class="fas fa-minus me-2"></i>Hide Form';
        button.className = 'btn btn-danger';
        // Focus on the subject input
        setTimeout(() => {
            const subjectInput = form.querySelector('input[name="subject"]');
            if (subjectInput) subjectInput.focus();
        }, 100);
    } else {
        form.style.display = 'none';
        button.innerHTML = '<i class="fas fa-plus me-2"></i>Add Subject';
        button.className = 'btn btn-success';
    }
}

// Form validation for add subject form
document.addEventListener('DOMContentLoaded', function() {
    const addSubjectForm = document.getElementById('addSubjectFormElement');
    if (addSubjectForm) {
        addSubjectForm.addEventListener('submit', function(e) {
            const subject = this.querySelector('input[name="subject"]').value.trim();
            const score = parseFloat(this.querySelector('input[name="score"]').value);
            
            if (!subject) {
                e.preventDefault();
                alert('Please enter a subject name.');
                return false;
            }
            
            if (isNaN(score) || score < 0 || score > 100) {
                e.preventDefault();
                alert('Please enter a valid score between 0 and 100.');
                return false;
            }
        });
    }
});
</script>

<%- include('../layout/footer') %>
