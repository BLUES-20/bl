<%- include('../layout/header') %>

<div class="container mt-4">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-envelope-open me-2"></i>Contact Message
            </h2>

            <% if (message.status === 'unread') { %>
                <span class="badge bg-danger">Unread</span>
            <% } else if (message.status === 'read') { %>
                <span class="badge bg-info">Read</span>
            <% } else if (message.status === 'replied') { %>
                <span class="badge bg-success">Replied</span>
                <% if (message.staff_first_name) { %>
                    <small class="text-muted ms-2">
                        by <%= message.staff_first_name %> <%= message.staff_last_name %>
                    </small>
                <% } %>
            <% } else if (message.status === 'archived') { %>
                <span class="badge bg-secondary">Archived</span>
            <% } %>
        </div>

        <a href="/staff/contact-messages" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back
        </a>
    </div>

    <div class="row">
        <!-- Message Content -->
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Message Details
                    </h5>
                </div>

                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Name</strong>
                            <p class="form-control-plaintext"><%= message.name %></p>
                        </div>

                        <div class="col-md-6">
                            <strong>Email</strong>
                            <p class="form-control-plaintext">
                                <a href="mailto:<%= message.email %>"><%= message.email %></a>
                            </p>
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Subject</strong>
                        <p class="form-control-plaintext"><%= message.subject %></p>
                    </div>

                    <div class="mb-3">
                        <strong>Message</strong>
                        <div class="border rounded bg-light p-3">
                            <p class="mb-0" style="white-space: pre-wrap;">
                                <%= message.message %>
                            </p>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <strong>Submitted</strong>
                            <p class="form-control-plaintext">
                                <%= new Date(message.created_at).toLocaleDateString() %> 
                                at <%= new Date(message.created_at).toLocaleTimeString() %>
                            </p>
                        </div>

                        <% if (message.replied_at) { %>
                            <div class="col-md-6">
                                <strong>Replied</strong>
                                <p class="form-control-plaintext">
                                    <%= new Date(message.replied_at).toLocaleDateString() %> 
                                    at <%= new Date(message.replied_at).toLocaleTimeString() %>
                                </p>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Reply Section -->
            <div class="card shadow" id="reply">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-reply me-2"></i>Reply
                    </h5>
                </div>

                <div class="card-body">
                    <% if (message.status === 'replied' && message.reply_message) { %>
                        <div class="alert alert-success">
                            <h6>
                                <i class="fas fa-check-circle me-2"></i>Reply Sent
                            </h6>

                            <p>
                                <strong>Date:</strong>
                                <%= new Date(message.replied_at).toLocaleDateString() %>
                                at <%= new Date(message.replied_at).toLocaleTimeString() %>
                            </p>

                            <% if (message.staff_first_name) { %>
                                <p>
                                    <strong>By:</strong>
                                    <%= message.staff_first_name %> <%= message.staff_last_name %>
                                </p>
                            <% } %>

                            <hr>

                            <p class="mb-0" style="white-space: pre-wrap;">
                                <%= message.reply_message %>
                            </p>
                        </div>
                    <% } else { %>
                        <form action="/staff/contact-messages/<%= message.id %>/reply" method="POST">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Your Reply</label>
                                <textarea
                                    name="reply_message"
                                    id="reply_message"
                                    class="form-control"
                                    rows="5"
                                    required
                                    placeholder="Type your reply here..."
                                ></textarea>
                                <small class="text-muted">
                                    This will be emailed to <strong><%= message.email %></strong>
                                </small>
                            </div>

                            <div class="d-flex justify-content-between">
                                <button class="btn btn-success">
                                    <i class="fas fa-paper-plane me-2"></i>Send Reply
                                </button>

                                <a
                                    href="mailto:<%= message.email %>?subject=Re: <%= message.subject %>"
                                    class="btn btn-outline-primary"
                                >
                                    <i class="fas fa-envelope me-2"></i>Email Client
                                </a>
                            </div>
                        </form>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>Actions
                    </h6>
                </div>

                <div class="card-body d-grid gap-2">
                    <% if (message.status !== 'replied') { %>
                        <a href="#reply" class="btn btn-success">
                            <i class="fas fa-reply me-2"></i>Reply
                        </a>
                    <% } %>

                    <a
                        href="mailto:<%= message.email %>?subject=Re: <%= message.subject %>"
                        class="btn btn-outline-primary"
                    >
                        <i class="fas fa-envelope me-2"></i>Email Client
                    </a>

                    <hr>

                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle w-100" data-bs-toggle="dropdown">
                            <i class="fas fa-tag me-2"></i>Update Status
                        </button>
                        <ul class="dropdown-menu w-100">
                            <% ['read','unread','archived'].forEach(status => { %>
                                <li>
                                    <form action="/staff/contact-messages/<%= message.id %>/status" method="POST">
                                        <input type="hidden" name="status" value="<%= status %>">
                                        <button class="dropdown-item text-capitalize">
                                            Mark as <%= status %>
                                        </button>
                                    </form>
                                </li>
                            <% }) %>
                        </ul>
                    </div>

                    <hr>

                    <form
                        action="/staff/contact-messages/<%= message.id %>/delete"
                        method="POST"
                        onsubmit="return confirm('Delete this message permanently?');"
                    >
                        <button class="btn btn-outline-danger w-100">
                            <i class="fas fa-trash me-2"></i>Delete
                        </button>
                    </form>
                </div>
            </div>

            <!-- Quick Info -->
            <div class="card shadow">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Quick Info
                    </h6>
                </div>
                <div class="card-body">
                    <p><strong>ID:</strong> <code><%= message.id %></code></p>
                    <p><strong>Status:</strong> <%= message.status %></p>
                    <p><strong>Staff Reply ID:</strong> <%= message.staff_reply_id || 'None' %></p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const replyBtn = document.querySelector('a[href="#reply"]');
    const replyBox = document.getElementById('reply_message');

    if (replyBtn && replyBox) {
        replyBtn.addEventListener('click', e => {
            e.preventDefault();
            replyBox.scrollIntoView({ behavior: 'smooth' });
            replyBox.focus();
        });
    }
});
</script>

<%- include('../layout/footer') %>
